<template>
  <div class="ip-evaluation-container">
    <!-- 页面标题 -->
    <div class="header">
      <h1>少数民族民俗体育IP数据浏览系统</h1>
      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-label">总IP数量:</span>
          <span class="stat-value">{{ statistics.totalIPs }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">组别数量:</span>
          <span class="stat-value">{{ statistics.totalGroups }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">分析次数:</span>
          <span class="stat-value">{{ statistics.totalEvaluations }}</span>
        </div>
      </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="main-content">
      <!-- 左侧控制面板 -->
      <div class="control-panel">
        <!-- 指标筛选 -->
        <div class="filter-section">
          <h3>筛选条件</h3>
          
          <!-- 一级指标 -->
          <div class="indicator-group">
            <h4>一级指标</h4>
            <div class="checkbox-group">
              <label v-for="indicator in indicatorStructure.firstLevel" :key="indicator" class="checkbox-label">
                <input 
                  type="checkbox" 
                  v-model="selectedFirstLevel"
                  :value="indicator"
                  @change="updateFilteredIndicators"
                />
                {{ indicator }}
              </label>
            </div>
          </div>

          <!-- 二级指标 -->
          <div class="indicator-group">
            <h4>二级指标</h4>
            <div class="checkbox-group">
              <label v-for="indicator in indicatorStructure.secondLevel" :key="indicator" class="checkbox-label">
                <input 
                  type="checkbox" 
                  v-model="selectedSecondLevel"
                  :value="indicator"
                  @change="updateFilteredIndicators"
                />
                {{ indicator }}
              </label>
            </div>
          </div>
        </div>

        <!-- 数据输入 -->
        <div class="input-section">
          <h3>数据输入（三级指标）</h3>
          <div class="indicator-inputs">
            <div v-for="indicator in filteredThirdIndicators" :key="indicator" class="input-group">
              <label>{{ indicator }}</label>
              <input 
                type="number" 
                v-model.number="indicatorValues[indicator]"
                step="0.1"
                min="0"
                max="100"
                placeholder="请输入评分"
              />
            </div>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
          <button @click="addIP" class="btn btn-primary">添加IP</button>
          <button @click="updateSelectedIP" class="btn btn-secondary" :disabled="!selectedIP">修改IP</button>
          <button @click="deleteSelectedIP" class="btn btn-danger" :disabled="!selectedIP">删除IP</button>
          <button @click="evaluateIPs" class="btn btn-success" :disabled="ips.length < 2">分析IP</button>
          <button @click="performClustering" class="btn btn-info" :disabled="ips.length < 2">聚类分析</button>
          <button @click="generateTestData" class="btn btn-warning">生成测试数据</button>
          <button @click="viewHistory" class="btn btn-secondary">查看历史</button>
          <button @click="exportData" class="btn btn-light">导出数据</button>
        </div>

        <!-- 高级功能按钮 -->
        <div class="advanced-buttons">
          <h4>高级AI功能</h4>
          <button @click="trainNeuralNetwork" class="btn btn-ai" :disabled="ips.length < 5">神经网络训练</button>
          <button @click="performSHAPAnalysis" class="btn btn-ai" :disabled="ips.length < 2">SHAP模型解释</button>
          <button @click="performPCAAnalysis" class="btn btn-ai" :disabled="ips.length < 2">PCA降维分析</button>
          <button @click="advancedClusteringAnalysis" class="btn btn-ai" :disabled="ips.length < 2">高级聚类</button>
          <button @click="loadDailySportsNews" class="btn btn-news">体育动态</button>
        </div>

        <!-- IP列表 -->
        <div class="ip-list-section">
          <h3>IP列表</h3>
          <div class="group-filter">
            <label>筛选组别:</label>
            <select v-model="selectedGroup" @change="loadIPs">
              <option v-for="group in groups" :key="group" :value="group">{{ group }}</option>
            </select>
          </div>
          <div class="ip-list">
            <div 
              v-for="ip in ips" 
              :key="ip.id" 
              class="ip-item"
              :class="{ active: selectedIP?.id === ip.id }"
              @click="selectIP(ip)"
            >
              <div class="ip-name">{{ ip.name }}</div>
              <div class="ip-group">{{ ip.group }}</div>
              <div class="ip-score" v-if="ip.score !== undefined">评分: {{ ip.score.toFixed(2) }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧展示区域 -->
      <div class="display-panel">
        <!-- 图表区域 -->
        <div class="charts-container">
          <!-- 适应度变化曲线 -->
          <div class="chart-panel">
            <h3>适应度变化曲线</h3>
            <div class="chart">
              <canvas id="fitnessChart" ref="fitnessChart"></canvas>
            </div>
          </div>

          <!-- IP评分分布 -->
          <div class="chart-panel">
            <h3>IP评分分布</h3>
            <div class="chart">
              <canvas id="scoreChart" ref="scoreChart"></canvas>
            </div>
          </div>

          <!-- 雷达图 -->
          <div class="chart-panel">
            <h3>重要指标影响</h3>
            <div class="chart">
              <canvas id="radarChart" ref="radarChart"></canvas>
            </div>
          </div>

          <!-- 聚类分析图 -->
          <div class="chart-panel" v-if="clusteringResult">
            <h3>聚类分析结果</h3>
            <div class="chart">
              <canvas id="clusterChart" ref="clusterChart"></canvas>
            </div>
          </div>

          <!-- 神经网络训练损失曲线 -->
          <div class="chart-panel">
            <h3>神经网络训练损失</h3>
            <div class="chart">
              <canvas id="nnLossChart" ref="nnLossChart" v-if="neuralNetworkResult"></canvas>
              <div v-else class="chart-placeholder">
                点击"神经网络训练"按钮后显示训练损失曲线
              </div>
            </div>
          </div>

          <!-- 特征重要性图表 -->
          <div class="chart-panel">
            <h3>特征重要性分析</h3>
            <div class="chart">
              <canvas id="featureImportanceChart" ref="featureImportanceChart" v-if="neuralNetworkResult"></canvas>
              <div v-else class="chart-placeholder">
                点击"神经网络训练"按钮后显示特征重要性分析
              </div>
            </div>
          </div>

          <!-- SHAP值可视化 -->
          <div class="chart-panel">
            <h3>SHAP特征贡献度</h3>
            <div class="chart">
              <canvas id="shapChart" ref="shapChart" v-if="shapResult"></canvas>
              <div v-else class="chart-placeholder">
                点击"SHAP模型解释"按钮后显示特征贡献度分析
              </div>
            </div>
          </div>

          <!-- PCA降维散点图 -->
          <div class="chart-panel">
            <h3>PCA降维可视化</h3>
            <div class="chart">
              <canvas id="pcaChart" ref="pcaChart" v-if="pcaResult"></canvas>
              <div v-else class="chart-placeholder">
                点击"PCA降维分析"按钮后显示降维可视化图表
              </div>
            </div>
          </div>

          <!-- 高级聚类带凸包图表 -->
          <div class="chart-panel">
            <h3>高级聚类分析（含凸包）</h3>
            <div class="chart">
              <div v-if="advancedClusterImage" class="ml-chart-image">
                <img :src="advancedClusterImage" alt="高级聚类分析图" />
              </div>
              <div v-else class="chart-placeholder">
                点击"高级聚类"按钮后显示带凸包的聚类分析图表
              </div>
            </div>
          </div>
        </div>

        <!-- 计算日志 -->
        <div class="log-panel">
          <h3>计算过程日志</h3>
          <div class="log-content" ref="logContent">
            <div v-for="(log, index) in logs" :key="index" class="log-entry">
              {{ log }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 模态框 -->
    <!-- 添加/编辑IP模态框 -->
    <div v-if="showIPDialog" class="modal" @click="closeDialogs">
      <div class="modal-content" @click.stop>
        <h3>{{ editMode ? '编辑IP' : '添加IP' }}</h3>
        <div class="form-group">
          <label>IP名称:</label>
          <input v-model="ipForm.name" type="text" placeholder="请输入IP名称" />
        </div>
        <div class="form-group">
          <label>组别:</label>
          <input v-model="ipForm.group" type="text" placeholder="请输入组别" />
        </div>
        <div class="modal-actions">
          <button @click="saveIP" class="btn btn-primary">保存</button>
          <button @click="closeDialogs" class="btn btn-secondary">取消</button>
        </div>
      </div>
    </div>

    <!-- 历史记录模态框 -->
    <div v-if="showHistoryDialog" class="modal" @click="closeDialogs">
      <div class="modal-content large" @click.stop>
        <h3>分析历史记录</h3>
        <div class="history-list">
          <div 
            v-for="record in historyRecords" 
            :key="record.id"
            class="history-item"
            @click="loadHistoryRecord(record)"
          >
            <div class="history-time">{{ formatDate(record.timestamp) }}</div>
            <div class="history-info">IP数量: {{ record.ipsCount }}</div>
          </div>
        </div>
        <div class="modal-actions">
          <button @click="closeDialogs" class="btn btn-secondary">关闭</button>
        </div>
      </div>
    </div>

    <!-- 聚类设置模态框 -->
    <div v-if="showClusterDialog" class="modal" @click="closeDialogs">
      <div class="modal-content" @click.stop>
        <h3>聚类分析设置</h3>
        <div class="form-group">
          <label>聚类数量:</label>
          <input v-model.number="clusterCount" type="number" min="2" :max="ips.length" />
        </div>
        <div class="modal-actions">
          <button @click="runClustering" class="btn btn-primary">开始聚类</button>
          <button @click="closeDialogs" class="btn btn-secondary">取消</button>
        </div>
      </div>
    </div>

    <!-- 加载遮罩 -->
    <div v-if="loading" class="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">{{ loadingText }}</div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, nextTick } from 'vue';
import { ipApi, pythonMLApi, type IP, type EvaluationResult, type ClusteringResult, type IndicatorStructure } from '../utils/api';
import {
  Chart,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend,
  RadialLinearScale,
  ArcElement,
  ScatterController,
  LineController,
  BarController,
  RadarController
} from 'chart.js';

// 注册Chart.js组件
Chart.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend,
  RadialLinearScale,
  ArcElement,
  ScatterController,
  LineController,
  BarController,
  RadarController
);

// IP评估相关接口扩展
interface IPWithScore extends IP {
  score?: number;
}

// 响应式数据
const loading = ref(false);
const loadingText = ref('加载中...');

// 指标结构
const indicatorStructure = ref<IndicatorStructure>({
  firstLevel: [],
  secondLevel: [],
  firstToSecond: {},
  secondToThird: {},
  allThird: []
});

// 筛选条件
const selectedFirstLevel = ref<string[]>([]);
const selectedSecondLevel = ref<string[]>([]);
const filteredThirdIndicators = ref<string[]>([]);

// 指标值输入
const indicatorValues = ref<Record<string, number>>({});

// IP数据
const ips = ref<IPWithScore[]>([]);
const selectedIP = ref<IPWithScore | null>(null);
const selectedGroup = ref('全部');
const groups = ref<string[]>(['全部']);

// 评估结果
const evaluationResult = ref<EvaluationResult | null>(null);
const clusteringResult = ref<ClusteringResult | null>(null);

// Python ML API结果
const neuralNetworkResult = ref<any>(null);
const shapResult = ref<any>(null);
const pcaResult = ref<any>(null);
const advancedClusterResult = ref<any>(null);
const advancedClusterImage = ref<string>('');

// 统计信息
const statistics = reactive({
  totalIPs: 0,
  totalGroups: 0,
  totalEvaluations: 0
});

// 日志
const logs = ref<string[]>([]);

// 对话框状态
const showIPDialog = ref(false);
const showHistoryDialog = ref(false);
const showClusterDialog = ref(false);
const editMode = ref(false);

// 表单数据
const ipForm = reactive({
  name: '',
  group: ''
});

// 历史记录
const historyRecords = ref<any[]>([]);
const clusterCount = ref(2);

// 生命周期
onMounted(async () => {
  await loadInitialData();
});

// 方法
const loadInitialData = async () => {
  loading.value = true;
  try {
    await Promise.all([
      loadIndicatorStructure(),
      loadGroups(),
      loadIPs(),
      loadStatistics()
    ]);
  } catch (error) {
    console.error('加载初始数据失败:', error);
    addLog(`加载初始数据失败: ${error}`);
  } finally {
    loading.value = false;
  }
};

const loadIndicatorStructure = async () => {
  try {
    const response = await ipApi.getIndicators();
    if (response.data) {
      indicatorStructure.value = response.data;
      filteredThirdIndicators.value = response.data.allThird;
      initializeIndicatorValues();
    }
  } catch (error) {
    console.error('加载指标结构失败:', error);
  }
};

const updateFilteredIndicators = async () => {
  try {
    const response = await ipApi.getFilteredIndicators(
      selectedFirstLevel.value,
      selectedSecondLevel.value
    );
    if (response.data) {
      filteredThirdIndicators.value = response.data;
      initializeIndicatorValues();
    }
  } catch (error) {
    console.error('更新筛选指标失败:', error);
  }
};

const initializeIndicatorValues = () => {
  indicatorValues.value = {};
  filteredThirdIndicators.value.forEach(indicator => {
    indicatorValues.value[indicator] = 0;
  });
};

const loadGroups = async () => {
  try {
    const response = await ipApi.getGroups();
    if (response.data) {
      groups.value = response.data;
    }
  } catch (error) {
    console.error('加载组别失败:', error);
  }
};

const loadIPs = async () => {
  try {
    const group = selectedGroup.value === '全部' ? undefined : selectedGroup.value;
    const response = await ipApi.getAllIPs(group);
    if (response.data) {
      ips.value = response.data;
    }
  } catch (error) {
    console.error('加载IP失败:', error);
  }
};

const loadStatistics = async () => {
  try {
    const response = await ipApi.getStatistics();
    Object.assign(statistics, response.data);
  } catch (error) {
    console.error('加载统计信息失败:', error);
  }
};

const addIP = () => {
  if (!validateIndicatorValues()) {
    alert('请填写所有三级指标');
    return;
  }
  
  ipForm.name = '';
  ipForm.group = '';
  editMode.value = false;
  showIPDialog.value = true;
};

const updateSelectedIP = () => {
  if (!selectedIP.value) return;
  
  if (!validateIndicatorValues()) {
    alert('请填写所有三级指标');
    return;
  }
  
  ipForm.name = selectedIP.value.name;
  ipForm.group = selectedIP.value.group;
  editMode.value = true;
  showIPDialog.value = true;
};

const deleteSelectedIP = async () => {
  if (!selectedIP.value) return;
  
  if (!confirm(`确定要删除IP "${selectedIP.value.name}" 吗？`)) return;
  
  try {
    loading.value = true;
    await ipApi.deleteIP(selectedIP.value.id);
    addLog(`已删除IP: ${selectedIP.value.name}`);
    selectedIP.value = null;
    await loadIPs();
    await loadStatistics();
  } catch (error) {
    console.error('删除IP失败:', error);
    alert('删除IP失败');
  } finally {
    loading.value = false;
  }
};

const saveIP = async () => {
  if (!ipForm.name.trim() || !ipForm.group.trim()) {
    alert('请填写IP名称和组别');
    return;
  }
  
  if (!validateIndicatorValues()) {
    alert('请填写所有三级指标');
    return;
  }
  
  try {
    loading.value = true;
    loadingText.value = editMode.value ? '更新IP中...' : '添加IP中...';
    
    const indicators = filteredThirdIndicators.value.map(indicator => 
      indicatorValues.value[indicator] || 0
    );
    
    const ipData = {
      name: ipForm.name.trim(),
      group: ipForm.group.trim(),
      indicators
    };
    
    if (editMode.value && selectedIP.value) {
      await ipApi.updateIP(selectedIP.value.id, ipData);
      addLog(`已更新IP: ${ipData.name}`);
    } else {
      await ipApi.addIP(ipData);
      addLog(`已添加IP: ${ipData.name}`);
    }
    
    showIPDialog.value = false;
    await loadIPs();
    await loadGroups();
    await loadStatistics();
  } catch (error) {
    console.error('保存IP失败:', error);
    alert(error instanceof Error ? error.message : '保存IP失败');
  } finally {
    loading.value = false;
  }
};

const selectIP = (ip: IP) => {
  selectedIP.value = ip;
  
  // 更新指标值
  filteredThirdIndicators.value.forEach((indicator, index) => {
    indicatorValues.value[indicator] = ip.indicators[index] || 0;
  });
};

const evaluateIPs = async () => {
  if (ips.value.length < 2) {
    alert('至少需要2个IP进行评估');
    return;
  }
  
  try {
    loading.value = true;
    loadingText.value = '评估中...';
    
    const response = await ipApi.evaluate(selectedGroup.value, filteredThirdIndicators.value);
    if (response.data) {
      evaluationResult.value = response.data;
      
      addLog('=== 评估完成 ===');
      addLog(`使用AHP计算权重: ${response.data.weights.map(w => w.toFixed(3)).join(', ')}`);
      addLog('IP评估结果:');
      response.data.evaluation.forEach(result => {
        addLog(`${result.rank}. ${result.name}: ${result.score.toFixed(2)} (±${result.error.toFixed(2)})`);
      });
      
      // 更新IP列表中的评分
      ips.value.forEach((ip) => {
        const result = response.data?.evaluation.find(r => r.name === ip.name);
        if (result) {
          (ip as any).score = result.score;
        }
      });
      
      await loadStatistics();
      renderCharts();
    }
  } catch (error) {
    console.error('评估失败:', error);
    alert('评估失败');
  } finally {
    loading.value = false;
  }
};

const performClustering = () => {
  if (ips.value.length < 2) {
    alert('至少需要2个IP进行聚类分析');
    return;
  }
  
  clusterCount.value = Math.min(2, ips.value.length);
  showClusterDialog.value = true;
};

const runClustering = async () => {
  try {
    loading.value = true;
    loadingText.value = '聚类分析中...';
    
    const response = await ipApi.clustering(selectedGroup.value, clusterCount.value);
    if (response.data) {
      clusteringResult.value = response.data;
      
      addLog('=== 聚类分析完成 ===');
      addLog(`聚类数量: ${clusterCount.value}`);
      response.data.ipsWithClusters.forEach(ip => {
        addLog(`${ip.name}: 簇 ${ip.cluster + 1}`);
      });
      
      showClusterDialog.value = false;
      renderCharts();
    }
  } catch (error) {
    console.error('聚类分析失败:', error);
    alert('聚类分析失败');
  } finally {
    loading.value = false;
  }
};

const generateTestData = async () => {
  if (!confirm('确定要生成测试数据吗？这将添加10个测试IP。')) return;
  
  try {
    loading.value = true;
    loadingText.value = '生成测试数据中...';
    
    const response = await ipApi.generateTestData(10);
    if (response.data) {
      addLog(`成功生成${response.data.addedIPs.length}个测试IP`);
      
      await loadIPs();
      await loadGroups();
      await loadStatistics();
    }
  } catch (error) {
    console.error('生成测试数据失败:', error);
    alert('生成测试数据失败');
  } finally {
    loading.value = false;
  }
};

const viewHistory = async () => {
  try {
    const response = await ipApi.getHistory();
    if (response.data) {
      historyRecords.value = response.data;
      showHistoryDialog.value = true;
    }
  } catch (error) {
    console.error('加载历史记录失败:', error);
  }
};

const loadHistoryRecord = async (record: any) => {
  try {
    const response = await ipApi.getHistoryById(record.id);
    evaluationResult.value = response.data;
    
    addLog('=== 加载历史记录 ===');
    addLog(`时间: ${formatDate(record.timestamp)}`);
    addLog(`IP数量: ${record.ipsCount}`);
    
    showHistoryDialog.value = false;
    renderCharts();
  } catch (error) {
    console.error('加载历史记录失败:', error);
  }
};

const exportData = async () => {
  try {
    const response = await ipApi.exportData();
    const blob = new Blob([JSON.stringify(response, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ip-evaluation-data-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    addLog('数据导出成功');
  } catch (error) {
    console.error('导出数据失败:', error);
    alert('导出数据失败');
  }
};

const validateIndicatorValues = () => {
  return filteredThirdIndicators.value.every(indicator => 
    indicatorValues.value[indicator] !== undefined && 
    indicatorValues.value[indicator] !== null &&
    !isNaN(indicatorValues.value[indicator])
  );
};

const addLog = (message: string) => {
  const timestamp = new Date().toLocaleTimeString();
  logs.value.push(`[${timestamp}] ${message}`);
  
  nextTick(() => {
    const logContent = document.querySelector('.log-content');
    if (logContent) {
      logContent.scrollTop = logContent.scrollHeight;
    }
  });
};

const renderCharts = () => {
  nextTick(() => {
    // 1. 适应度变化曲线
    if (evaluationResult.value && evaluationResult.value.fitnessHistory.length > 0) {
      renderFitnessChart();
    }
    
    // 2. IP评分分布
    if (evaluationResult.value && evaluationResult.value.evaluation.length > 0) {
      renderScoreChart();
    }
    
    // 3. 重要指标影响雷达图
    if (evaluationResult.value && evaluationResult.value.weights.length > 0) {
      renderRadarChart();
    }
    
    // 4. 聚类分析图
    if (clusteringResult.value) {
      renderClusterChart();
    }
  });
};

// 渲染适应度变化曲线
const renderFitnessChart = () => {
  const canvas = document.querySelector('#fitnessChart') as HTMLCanvasElement;
  if (!canvas || !evaluationResult.value) return;
  
  // 销毁现有图表
  Chart.getChart(canvas)?.destroy();
  
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  
  const fitnessHistory = evaluationResult.value.fitnessHistory;
  const iterations = fitnessHistory.length;
  const ipCount = fitnessHistory[0]?.length || 0;
  
  // 计算每次迭代的平均适应度
  const avgFitness = fitnessHistory.map(iteration => 
    iteration.reduce((sum, val) => sum + val, 0) / iteration.length
  );
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({ length: iterations }, (_, i) => `第${i + 1}代`),
      datasets: [{
        label: '平均适应度',
        data: avgFitness,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: '遗传算法适应度收敛过程'
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: '适应度值'
          }
        },
        x: {
          title: {
            display: true,
            text: '迭代次数'
          }
        }
      }
    }
  });
};

// 渲染IP评分分布柱状图
const renderScoreChart = () => {
  const canvas = document.querySelector('#scoreChart') as HTMLCanvasElement;
  if (!canvas || !evaluationResult.value) return;
  
  // 销毁现有图表
  Chart.getChart(canvas)?.destroy();
  
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  
  const evaluation = evaluationResult.value.evaluation;
  const labels = evaluation.map(item => item.name);
  const scores = evaluation.map(item => item.score);
  const errors = evaluation.map(item => item.error);
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'IP评分',
        data: scores,
        backgroundColor: 'rgba(54, 162, 235, 0.8)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }, {
        label: '误差范围',
        data: errors,
        backgroundColor: 'rgba(255, 99, 132, 0.5)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'IP综合评分排名'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: '评分'
          }
        },
        x: {
          title: {
            display: true,
            text: 'IP名称'
          }
        }
      }
    }
  });
};

// 渲染雷达图
const renderRadarChart = () => {
  const canvas = document.querySelector('#radarChart') as HTMLCanvasElement;
  if (!canvas || !evaluationResult.value) return;
  
  // 销毁现有图表
  Chart.getChart(canvas)?.destroy();
  
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  
  const weights = evaluationResult.value.weights;
  const indicators = filteredThirdIndicators.value;
  
  // 选择权重最高的前8个指标用于雷达图显示
  const indexedWeights = weights.map((weight, index) => ({ weight, index }));
  indexedWeights.sort((a, b) => b.weight - a.weight);
  const topIndicators = indexedWeights.slice(0, 8);
  
  const radarLabels = topIndicators.map(item => indicators[item.index] || `指标${item.index + 1}`);
  const radarWeights = topIndicators.map(item => item.weight * 100); // 转换为百分比
  
  new Chart(ctx, {
    type: 'radar',
    data: {
      labels: radarLabels,
      datasets: [{
        label: '指标权重(%)',
        data: radarWeights,
        fill: true,
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: 'rgb(255, 99, 132)',
        pointBackgroundColor: 'rgb(255, 99, 132)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(255, 99, 132)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: '关键指标权重分布'
        }
      },
      scales: {
        r: {
          angleLines: {
            display: false
          },
          suggestedMin: 0,
          suggestedMax: Math.max(...radarWeights) * 1.2
        }
      }
    }
  });
};

// 渲染聚类分析散点图
const renderClusterChart = () => {
  const canvas = document.querySelector('#clusterChart') as HTMLCanvasElement;
  if (!canvas || !clusteringResult.value) return;
  
  // 销毁现有图表
  Chart.getChart(canvas)?.destroy();
  
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  
  const ipsWithClusters = clusteringResult.value.ipsWithClusters;
  const clusters = [...new Set(ipsWithClusters.map(ip => ip.cluster))];
  const colors = ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 205, 86, 0.8)', 'rgba(75, 192, 192, 0.8)'];
  
  const datasets = clusters.map(cluster => {
    const clusterIPs = ipsWithClusters.filter(ip => ip.cluster === cluster);
    return {
      label: `簇 ${cluster + 1}`,
      data: clusterIPs.map((ip, index) => ({
        x: ip.indicators[0] || 0, // 使用第一个指标作为X轴
        y: ip.indicators[1] || 0, // 使用第二个指标作为Y轴
        label: ip.name
      })),
      backgroundColor: colors[cluster % colors.length],
      borderColor: colors[cluster % colors.length].replace('0.8', '1'),
    };
  });
  
  new Chart(ctx, {
    type: 'scatter',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: '聚类分析结果'
        },
        tooltip: {
          callbacks: {
            label: function(context: any) {
              return `${context.dataset.label}: ${context.parsed.label || 'IP'} (${context.parsed.x.toFixed(1)}, ${context.parsed.y.toFixed(1)})`;
            }
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: '第一维度'
          }
        },
        y: {
          title: {
            display: true,
            text: '第二维度'
          }
        }
      }
    }
  });
};

const closeDialogs = () => {
  showIPDialog.value = false;
  showHistoryDialog.value = false;
  showClusterDialog.value = false;
};

// 高级AI功能函数
const trainNeuralNetwork = async () => {
  if (ips.value.length < 5) {
    alert('至少需要5个IP进行神经网络训练');
    return;
  }
  
  try {
    loading.value = true;
    loadingText.value = '神经网络训练中...';
    
    const response = await pythonMLApi.trainNeuralNetwork(ips.value);
    if (response.success) {
      // 保存结果
      neuralNetworkResult.value = response;
      
      addLog('=== 神经网络训练完成 ===');
      addLog(`训练轮次: ${response.model_info.epochs}`);
      addLog(`最终损失: ${response.model_info.final_loss.toFixed(4)}`);
      addLog('预测结果:');
      response.predictions.forEach((pred: any) => {
        addLog(`${pred.name}: 预测评分 ${pred.predicted_score.toFixed(2)} (置信度: ${pred.confidence.toFixed(2)})`);
      });
      
      // 显示特征重要性
      addLog('特征重要性:');
      response.feature_importance.forEach((importance: number, index: number) => {
        addLog(`指标${index + 1}: ${importance.toFixed(3)}`);
      });
      
      // 渲染神经网络相关图表
      nextTick(() => {
        renderNeuralNetworkCharts();
      });
    } else {
      alert(`神经网络训练失败: ${response.error}`);
    }
  } catch (error) {
    console.error('神经网络训练错误:', error);
    alert('神经网络训练失败');
  } finally {
    loading.value = false;
  }
};

const performSHAPAnalysis = async () => {
  if (ips.value.length < 2) {
    alert('至少需要2个IP进行SHAP解释');
    return;
  }
  
  try {
    loading.value = true;
    loadingText.value = 'SHAP模型解释中...';
    
    const response = await pythonMLApi.shapExplain(ips.value);
    if (response.success) {
      // 保存结果
      shapResult.value = response;
      
      addLog('=== SHAP模型解释完成 ===');
      addLog('各特征的平均SHAP值:');
      response.mean_shap_values.forEach((value: number, index: number) => {
        addLog(`${response.feature_names[index]}: ${value.toFixed(4)}`);
      });
      
      addLog('各IP的SHAP解释:');
      response.ip_explanations.forEach((explanation: any) => {
        addLog(`${explanation.name}: 预测值 ${explanation.predicted_value.toFixed(2)}`);
      });
      
      // 渲染SHAP图表
      nextTick(() => {
        renderSHAPChart();
      });
    } else {
      alert(`SHAP解释失败: ${response.error}`);
    }
  } catch (error) {
    console.error('SHAP解释错误:', error);
    alert('SHAP解释失败');
  } finally {
    loading.value = false;
  }
};

const performPCAAnalysis = async () => {
  if (ips.value.length < 2) {
    alert('至少需要2个IP进行PCA分析');
    return;
  }
  
  try {
    loading.value = true;
    loadingText.value = 'PCA降维分析中...';
    
    const response = await pythonMLApi.pcaAnalysis(ips.value, 2);
    if (response.success) {
      // 保存结果
      pcaResult.value = response;
      
      addLog('=== PCA降维分析完成 ===');
      addLog(`降维维度: ${response.n_components}`);
      addLog(`总方差解释比例: ${(response.total_variance_explained * 100).toFixed(2)}%`);
      addLog('各主成分方差解释比例:');
      response.explained_variance_ratio.forEach((ratio: number, index: number) => {
        addLog(`主成分${index + 1}: ${(ratio * 100).toFixed(2)}%`);
      });
      
      addLog('PCA降维结果:');
      response.pca_results.forEach((result: any) => {
        addLog(`${result.name}: [${result.coordinates.map((c: number) => c.toFixed(3)).join(', ')}]`);
      });
      
      // 渲染PCA图表
      nextTick(() => {
        renderPCAChart();
      });
    } else {
      alert(`PCA分析失败: ${response.error}`);
    }
  } catch (error) {
    console.error('PCA分析错误:', error);
    alert('PCA分析失败');
  } finally {
    loading.value = false;
  }
};

const advancedClusteringAnalysis = async () => {
  if (ips.value.length < 2) {
    alert('至少需要2个IP进行高级聚类分析');
    return;
  }
  
  const nClusters = prompt('请输入聚类数量:', '2');
  if (!nClusters || isNaN(Number(nClusters))) return;
  
  try {
    loading.value = true;
    loadingText.value = '高级聚类分析中...';
    
    const response = await pythonMLApi.advancedClustering(ips.value, Number(nClusters), true);
    if (response.success) {
      // 保存结果
      advancedClusterResult.value = response;
      
      addLog('=== 高级聚类分析完成 ===');
      addLog(`聚类数量: ${nClusters}`);
      addLog(`轮廓系数: ${response.quality_metrics.silhouette_score.toFixed(4)}`);
      addLog(`Calinski-Harabasz指数: ${response.quality_metrics.calinski_harabasz_score.toFixed(4)}`);
      
      if (response.pca_info.used && response.pca_info.variance_explained) {
        addLog(`PCA方差解释: ${response.pca_info.variance_explained.map((v: number) => (v * 100).toFixed(1) + '%').join(', ')}`);
      }
      
      addLog('聚类结果:');
      response.clustering_results.forEach((result: any) => {
        addLog(`${result.name}: 簇${result.cluster + 1} (距离质心: ${result.distance_to_centroid.toFixed(3)})`);
      });
      
      addLog('凸包信息:');
      response.convex_hulls.forEach((hull: any) => {
        addLog(`簇${hull.cluster_id + 1}: 面积 ${hull.area.toFixed(3)}`);
      });
      
      // 生成高级聚类可视化图表
      await generateAdvancedClusteringVisualization();
    } else {
      alert(`高级聚类分析失败: ${response.error}`);
    }
  } catch (error) {
    console.error('高级聚类分析错误:', error);
    alert('高级聚类分析失败');
  } finally {
    loading.value = false;
  }
};

const loadDailySportsNews = async () => {
  try {
    loading.value = true;
    loadingText.value = '加载体育动态中...';
    
    const response = await pythonMLApi.getDailySportsNews();
    if (response.success) {
      addLog('=== 今日新疆体育动态 ===');
      response.news.forEach((news: any) => {
        addLog(`📰 ${news.title}`);
        addLog(`   ${news.content}`);
        addLog(`   地区: ${news.region} | 项目: ${news.sport}`);
        addLog('');
      });
    } else {
      alert(`加载体育动态失败: ${response.error}`);
    }
  } catch (error) {
    console.error('加载体育动态错误:', error);
    alert('加载体育动态失败，请确保Python ML API服务正在运行');
  } finally {
    loading.value = false;
  }
};

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleString('zh-CN');
};

// ML图表渲染函数
const renderNeuralNetworkCharts = () => {
  if (!neuralNetworkResult.value) return;
  
  // 渲染训练损失曲线
  const lossCanvas = document.querySelector('#nnLossChart') as HTMLCanvasElement;
  if (lossCanvas) {
    Chart.getChart(lossCanvas)?.destroy();
    const ctx = lossCanvas.getContext('2d');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: neuralNetworkResult.value.training_losses.map((_: any, index: number) => `轮次${index + 1}`),
          datasets: [{
            label: '训练损失',
            data: neuralNetworkResult.value.training_losses,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '神经网络训练损失变化'
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: '损失值'
              }
            },
            x: {
              title: {
                display: true,
                text: '训练轮次'
              }
            }
          }
        }
      });
    }
  }
  
  // 渲染特征重要性柱状图
  const importanceCanvas = document.querySelector('#featureImportanceChart') as HTMLCanvasElement;
  if (importanceCanvas) {
    Chart.getChart(importanceCanvas)?.destroy();
    const ctx = importanceCanvas.getContext('2d');
    if (ctx) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: neuralNetworkResult.value.feature_importance.map((_: any, index: number) => `指标${index + 1}`),
          datasets: [{
            label: '特征重要性',
            data: neuralNetworkResult.value.feature_importance,
            backgroundColor: 'rgba(75, 192, 192, 0.8)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '神经网络特征重要性分析'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '重要性分数'
              }
            },
            x: {
              title: {
                display: true,
                text: '特征指标'
              }
            }
          }
        }
      });
    }
  }
};

const renderSHAPChart = () => {
  if (!shapResult.value) return;
  
  const shapCanvas = document.querySelector('#shapChart') as HTMLCanvasElement;
  if (shapCanvas) {
    Chart.getChart(shapCanvas)?.destroy();
    const ctx = shapCanvas.getContext('2d');
    if (ctx) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: shapResult.value.feature_names,
          datasets: [{
            label: '平均SHAP值',
            data: shapResult.value.mean_shap_values.map((v: number) => Math.abs(v)),
            backgroundColor: shapResult.value.mean_shap_values.map((v: number) => 
              v >= 0 ? 'rgba(54, 162, 235, 0.8)' : 'rgba(255, 99, 132, 0.8)'
            ),
            borderColor: shapResult.value.mean_shap_values.map((v: number) => 
              v >= 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)'
            ),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'SHAP特征贡献度分析'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'SHAP值绝对值'
              }
            },
            x: {
              title: {
                display: true,
                text: '特征'
              }
            }
          }
        }
      });
    }
  }
};

const renderPCAChart = () => {
  if (!pcaResult.value) return;
  
  const pcaCanvas = document.querySelector('#pcaChart') as HTMLCanvasElement;
  if (pcaCanvas) {
    Chart.getChart(pcaCanvas)?.destroy();
    const ctx = pcaCanvas.getContext('2d');
    if (ctx) {
      const colors = ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 205, 86, 0.8)', 'rgba(75, 192, 192, 0.8)'];
      const groups = [...new Set(pcaResult.value.pca_results.map((item: any) => item.group))];
      
      const datasets = groups.map((group, index) => {
        const groupData = pcaResult.value.pca_results.filter((item: any) => item.group === group);
        return {
          label: String(group),
          data: groupData.map((item: any) => ({
            x: item.coordinates[0],
            y: item.coordinates[1],
            label: item.name
          })),
          backgroundColor: colors[index % colors.length],
          borderColor: colors[index % colors.length].replace('0.8', '1'),
        };
      });
      
      new Chart(ctx, {
        type: 'scatter',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `PCA降维可视化 (方差解释: ${(pcaResult.value.total_variance_explained * 100).toFixed(1)}%)`
            },
            tooltip: {
              callbacks: {
                label: function(context: any) {
                  return `${context.dataset.label}: ${context.parsed.label} (${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)})`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: `主成分1 (${(pcaResult.value.explained_variance_ratio[0] * 100).toFixed(1)}%)`
              }
            },
            y: {
              title: {
                display: true,
                text: `主成分2 (${(pcaResult.value.explained_variance_ratio[1] * 100).toFixed(1)}%)`
              }
            }
          }
        }
      });
    }
  }
};

const generateAdvancedClusteringVisualization = async () => {
  if (!advancedClusterResult.value) return;
  
  try {
    // 调用Python API生成高级聚类可视化图表
    const response = await pythonMLApi.generateAdvancedPlot('clustering_with_hull', {
      clustering_results: advancedClusterResult.value.clustering_results,
      convex_hulls: advancedClusterResult.value.convex_hulls
    });
    
    if (response.success) {
      advancedClusterImage.value = response.image;
      addLog('高级聚类可视化图表生成成功');
    } else {
      addLog(`生成聚类图表失败: ${response.error}`);
    }
  } catch (error) {
    console.error('生成高级聚类图表错误:', error);
    addLog('生成聚类图表失败，使用基础可视化');
  }
};
</script>

<style scoped>
.ip-evaluation-container {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.header {
  margin-bottom: 20px;
}

.header h1 {
  color: #2c3e50;
  margin-bottom: 10px;
}

.stats-bar {
  display: flex;
  gap: 20px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.stat-label {
  font-weight: bold;
  color: #666;
}

.stat-value {
  color: #007bff;
  font-weight: bold;
}

.main-content {
  display: grid;
  grid-template-columns: 350px 1fr;
  gap: 20px;
  min-height: 80vh;
  align-items: start;
}

.control-panel {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  overflow: visible;
  height: auto;
  overflow-y: auto;
}

.control-panel::-webkit-scrollbar {
  width: 8px;
}

.control-panel::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.control-panel::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.control-panel::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.filter-section, .input-section, .ip-list-section {
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}

.filter-section h3, .input-section h3, .ip-list-section h3 {
  margin-bottom: 15px;
  color: #2c3e50;
}

.indicator-group {
  margin-bottom: 15px;
}

.indicator-group h4 {
  margin-bottom: 10px;
  color: #495057;
  font-size: 14px;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
  padding-right: 8px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  cursor: pointer;
  padding: 2px 0;
}

.checkbox-label:hover {
  background: #f8f9fa;
}

.indicator-inputs {
  max-height: 300px;
  overflow-y: auto;
  padding-right: 8px;
}

.indicator-inputs::-webkit-scrollbar {
  width: 6px;
}

.indicator-inputs::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.indicator-inputs::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.indicator-inputs::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.input-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 10px;
}

.input-group label {
  font-size: 12px;
  margin-bottom: 5px;
  color: #495057;
}

.input-group input {
  padding: 6px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
}

.action-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 20px;
}

.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary { background: #007bff; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-warning { background: #ffc107; color: black; }
.btn-info { background: #17a2b8; color: white; }
.btn-light { background: #f8f9fa; color: black; border: 1px solid #ddd; }
.btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.btn-news { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }

.group-filter {
  margin-bottom: 10px;
}

.group-filter label {
  font-size: 13px;
  margin-right: 8px;
}

.group-filter select {
  padding: 4px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.ip-list {
  max-height: 250px;
  overflow-y: auto;
  padding-right: 8px;
}

.ip-list::-webkit-scrollbar {
  width: 6px;
}

.ip-list::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.ip-list::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.ip-list::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.ip-item {
  padding: 8px;
  border: 1px solid #eee;
  border-radius: 4px;
  margin-bottom: 5px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.ip-item:hover {
  background: #f8f9fa;
}

.ip-item.active {
  background: #e3f2fd;
  border-color: #2196f3;
}

.ip-name {
  font-weight: bold;
  font-size: 13px;
}

.ip-group {
  font-size: 11px;
  color: #666;
}

.ip-score {
  font-size: 11px;
  color: #007bff;
  font-weight: bold;
}

.display-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
  height: fit-content;
}

.charts-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  min-height: 600px;
}

.chart-panel {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chart-panel h3 {
  margin-bottom: 10px;
  color: #2c3e50;
  font-size: 16px;
}

.chart {
  height: 200px;
  background: #f8f9fa;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
  position: relative;
}

.chart canvas {
  max-width: 100%;
  max-height: 100%;
}

.log-panel {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-height: 200px;
}

.log-panel h3 {
  margin-bottom: 10px;
  color: #2c3e50;
  font-size: 16px;
}

.log-content {
  height: calc(100% - 40px);
  overflow-y: auto;
  background: #f8f9fa;
  padding: 10px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  max-height: 250px;
}

.log-content::-webkit-scrollbar {
  width: 6px;
}

.log-content::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.log-content::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.log-content::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.log-entry {
  margin-bottom: 2px;
  color: #495057;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 8px;
  padding: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-content.large {
  max-width: 800px;
}

.modal-content h3 {
  margin-bottom: 15px;
  color: #2c3e50;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.history-list {
  max-height: 400px;
  overflow-y: auto;
}

.history-item {
  padding: 10px;
  border: 1px solid #eee;
  border-radius: 4px;
  margin-bottom: 5px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.history-item:hover {
  background: #f8f9fa;
}

.history-time {
  font-weight: bold;
  font-size: 14px;
}

.history-info {
  font-size: 12px;
  color: #666;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loading-text {
  color: white;
  margin-top: 10px;
  font-size: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.advanced-buttons {
  margin-bottom: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 2px solid #e9ecef;
}

.advanced-buttons h4 {
  margin-bottom: 10px;
  color: #495057;
  font-size: 14px;
  text-align: center;
}

.advanced-buttons .btn {
  width: 100%;
  margin-bottom: 5px;
  font-weight: bold;
}

.ml-chart-image {
  width: 100%;
  height: 200px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f8f9fa;
  border-radius: 4px;
}

.ml-chart-image img {
  max-width: 100%;
  max-height: 100%;
  border-radius: 4px;
}

.chart-placeholder {
  width: 100%;
  height: 200px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f8f9fa;
  color: #666;
  border-radius: 4px;
  font-style: italic;
  text-align: center;
  padding: 20px;
  font-size: 12px;
  line-height: 1.4;
}

.filter-section {
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
  max-height: 200px;
  overflow-y: auto;
}

.filter-section::-webkit-scrollbar {
  width: 6px;
}

.filter-section::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.filter-section::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.filter-section::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style> 