<template>
  <div class="dashboard-screen">
    <!-- 顶部导航和标题 -->
    <div class="header-section">
      <div class="header-left">
        <h1 class="main-title">少数民族民俗体育IP可视化大屏</h1>
        <div class="time-display">{{ currentTime }}</div>
          </div>
          </div>
      
    <!-- 主体内容区 -->
    <div class="main-content">
      <!-- 左侧数据统计面板 -->
      <div class="left-panel">
        <div class="stat-card">
          <div class="stat-icon">🏗️</div>
          <div class="stat-content">
            <div class="stat-value">{{ mapStats.totalProjects || totalProjects }}</div>
            <div class="stat-label">体育项目</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">📍</div>
          <div class="stat-content">
            <div class="stat-value">{{ mapStats.provinceCount || totalRegions }}</div>
            <div class="stat-label">覆盖省份</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🎯</div>
          <div class="stat-content">
            <div class="stat-value">{{ mapStats.cityCount || 0 }}</div>
            <div class="stat-label">覆盖城市</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">⭐</div>
          <div class="stat-content">
            <div class="stat-value">{{ averageScore }}</div>
            <div class="stat-label">平均评分</div>
          </div>
        </div>

        <!-- 地区排行榜 -->
        <div class="ranking-card">
          <h3>地区排行榜</h3>
          <div class="ranking-list">
            <div v-for="(region, index) in topRegions" :key="region.name" class="ranking-item">
              <div class="rank-number" :class="`rank-${index + 1}`">{{ index + 1 }}</div>
              <div class="region-name">{{ region.name }}</div>
              <div class="region-score">{{ region.score }}</div>
            </div>
          </div>
            </div>
          </div>
          
      <!-- 中央地图区域 -->
      <div class="map-container">
        <div class="map-header">
          <div class="map-title">中国民族体育项目分布图</div>
          <div class="map-navigation">
            <div class="map-breadcrumb">
              <span class="breadcrumb-item" @click="initChinaMap">中国</span>
              <span v-if="currentMapLevel !== 'china'" class="breadcrumb-separator">></span>
              <span v-if="currentMapLevel === 'province'" class="breadcrumb-item current">{{ currentMapName }}</span>
              <span v-if="currentMapLevel === 'city'" class="breadcrumb-item" @click="loadProvinceMap(mapHistory[mapHistory.length - 1])">{{ mapHistory[mapHistory.length - 1] }}</span>
              <span v-if="currentMapLevel === 'city'" class="breadcrumb-separator">></span>
              <span v-if="currentMapLevel === 'city'" class="breadcrumb-item current">{{ currentMapName }}</span>
    </div>
            <button v-if="mapHistory.length > 0" @click="goBackMap" class="back-btn">
              <span>← 返回</span>
          </button>
        </div>
            </div>
        <div id="chinaMap" class="china-map"></div>
        <div class="map-tip">
          {{ getMapTip() }}
          </div>
        </div>

      <!-- 右侧详情面板 -->
      <div class="right-panel">
        <!-- 实时数据流 -->
        <div class="realtime-card">
          <h3>实时数据流</h3>
          <div class="data-stream">
            <div v-for="item in realtimeData" :key="item.id" class="stream-item">
              <div class="stream-time">{{ item.time }}</div>
              <div class="stream-content">{{ item.content }}</div>
              </div>
            </div>
              </div>

        <!-- 项目类型分布 -->
        <div class="chart-card">
          <h3>项目类型分布</h3>
          <div id="typeChart" class="mini-chart"></div>
            </div>
          
        <!-- 月度趋势 -->
        <div class="chart-card">
          <h3>月度增长趋势</h3>
          <div id="trendChart" class="mini-chart"></div>
          </div>
        </div>
      </div>
          
    <!-- 底部状态栏 -->
    <div class="footer-section">
      <div class="footer-left">
        <span class="status-indicator online"></span>
        <span>系统运行正常</span>
              </div>
      <div class="footer-right">
        <span>可视化大屏模式</span>
        <span style="margin-left: 20px;">最后更新: {{ lastUpdateTime }}</span>
            </div>
          </div>
          
    <!-- 粒子背景效果 -->
    <div class="particle-background" ref="particleContainer"></div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, reactive } from 'vue'
import { useRouter } from 'vue-router'
import * as echarts from 'echarts'
import { ipApi } from '../utils/api'

const router = useRouter()

// 响应式数据
const currentTime = ref('')
const lastUpdateTime = ref('')
const totalProjects = ref(156)
const totalRegions = ref(34)
const averageScore = ref(8.7)

// 地图钻取相关数据
const currentMapLevel = ref('china') // 当前地图级别：china, province, city
const currentMapName = ref('中国') // 当前地图名称
const mapHistory = ref<string[]>([]) // 地图导航历史

// 数据库IP地址数据
const ipLocationData = ref<any[]>([])
const mapStats = reactive({
  totalProjects: 0,
  provinceCount: 0,
  cityCount: 0,
  regionDistribution: {} as Record<string, number>
})

// 省份名称到拼音的映射
const provinces: Record<string, string> = {
  "台湾": "taiwan",
  "河北": "hebei", 
  "山西": "shanxi",
  "辽宁": "liaoning",
  "吉林": "jilin",
  "黑龙江": "heilongjiang",
  "江苏": "jiangsu",
  "浙江": "zhejiang",
  "安徽": "anhui",
  "福建": "fujian",
  "江西": "jiangxi",
  "山东": "shandong",
  "河南": "henan",
  "湖北": "hubei",
  "湖南": "hunan",
  "广东": "guangdong",
  "海南": "hainan",
  "四川": "sichuan",
  "贵州": "guizhou",
  "云南": "yunnan",
  "陕西": "shanxi1",
  "甘肃": "gansu",
  "青海": "qinghai",
  "新疆": "xinjiang",
  "广西": "guangxi",
  "内蒙古": "neimenggu",
  "宁夏": "ningxia",
  "西藏": "xizang",
  "北京": "beijing",
  "天津": "tianjin",
  "上海": "shanghai",
  "重庆": "chongqing",
  "香港": "xianggang",
  "澳门": "aomen"
}

// 直辖市和特别行政区（只有二级）
const specialRegions = ["北京", "天津", "上海", "重庆", "香港", "澳门"]

// 城市名称到编码的映射（从实际文件加载）
let cityMap: Record<string, string> = {}

// 模拟数据
const topRegions = ref([
  { name: '新疆', score: 9.8 },
  { name: '西藏', score: 9.5 },
  { name: '内蒙古', score: 9.3 },
  { name: '云南', score: 9.1 },
  { name: '贵州', score: 8.9 }
])

const realtimeData = ref([
  { id: 1, time: '14:32', content: '新疆地区新增马术项目数据' },
  { id: 2, time: '14:30', content: '西藏地区牦牛赛跑数据更新' },
  { id: 3, time: '14:28', content: '云南地区龙舟比赛数据同步' },
  { id: 4, time: '14:25', content: '内蒙古摔跤项目分析完成' }
])

// 地图实例
let mapChart: echarts.ECharts | null = null
let typeChart: echarts.ECharts | null = null
let trendChart: echarts.ECharts | null = null

// 更新时间
const updateTime = () => {
  const now = new Date()
  currentTime.value = now.toLocaleTimeString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
  lastUpdateTime.value = now.toLocaleTimeString('zh-CN', {
    hour: '2-digit',
    minute: '2-digit'
  })
}

// 渲染地图的通用函数
const renderMap = async (mapType: string, mapName: string, data?: any[], zoom?: number, center?: [number, number]) => {
  if (!mapChart) return

  const option = {
    backgroundColor: 'transparent',
    title: {
      show: false
    },
    tooltip: {
      trigger: 'item',
      formatter: (params: any) => {
        return `${params.name}`
      },
      backgroundColor: 'rgba(0, 20, 40, 0.9)',
      borderColor: '#00d4ff',
      borderWidth: 1,
      textStyle: {
        color: '#fff',
        fontSize: 14
      }
    },
    series: [
      {
        name: mapName,
        type: 'map',
        map: mapType,
        roam: true,
        zoom: zoom || 1.2,
        center: center || [105, 36],
        itemStyle: {
          normal: {
            areaColor: '#001830',
            borderColor: '#00d4ff',
            borderWidth: 1,
            shadowColor: 'rgba(0, 212, 255, 0.3)',
            shadowBlur: 10
          },
          emphasis: {
            areaColor: '#003d6b',
            borderColor: '#00ff88',
            borderWidth: 2,
            shadowColor: 'rgba(0, 255, 136, 0.6)',
            shadowBlur: 20
          }
        },
        label: {
          normal: {
            show: true,
            fontSize: 10,
            color: '#fff'
          },
          emphasis: {
            show: true,
            fontSize: 12,
            color: '#00ff88'
          }
        },
        data: data || []
      }
    ]
  }

  mapChart.setOption(option)
}

// 返回上一级地图
const goBackMap = () => {
  if (mapHistory.value.length > 0) {
    if (currentMapLevel.value === 'city') {
      // 从城市级返回到省份级
      const provinceName = mapHistory.value[mapHistory.value.length - 1]
      mapHistory.value.pop() // 移除省份名称
      loadProvinceMap(provinceName)
    } else if (currentMapLevel.value === 'province') {
      // 从省份级返回到全国
      mapHistory.value.pop() // 移除"中国"
      initChinaMap()
    }
  }
}

// 初始化中国地图
const initChinaMap = async () => {
  const mapElement = document.getElementById('chinaMap')
  if (!mapElement) return

  try {
    // 加载IP地址数据
    const locationData = await loadIPLocationData()
    
    // 加载中国地图数据
    const response = await fetch('/map/china.json')
    const mapData = await response.json()
    
    // 注册地图
    echarts.registerMap('china', mapData)

    mapChart = echarts.init(mapElement)

    // 生成省份数据，包含项目数量
    const chinaData = mapData.features.map((feature: any) => {
      const provinceName = feature.properties.name
      const projectCount = mapStats.regionDistribution[provinceName] || 0
      
      return {
        name: provinceName,
        value: projectCount,
        itemStyle: {
          areaColor: projectCount > 0 ? getHeatColor(projectCount) : '#f0f0f0'
        }
      }
    })

    // 更新统计信息显示
    totalProjects.value = mapStats.totalProjects
    totalRegions.value = mapStats.provinceCount

    // 重置地图状态
    currentMapLevel.value = 'china'
    currentMapName.value = '中国'
    mapHistory.value = []

    const option = {
      title: {
        text: `中国民族体育项目分布图 (${mapStats.totalProjects}个项目)`,
        left: 'center',
        top: 20,
        textStyle: {
          color: '#fff',
          fontSize: 18,
          fontWeight: 'bold'
        }
      },
      tooltip: {
        trigger: 'item',
        formatter: function (params: any) {
          const data = params.data || {}
          const projectCount = data.value || 0
          
          if (projectCount > 0) {
            // 获取该省份的具体项目信息
            const provinceProjects = locationData.filter(item => item.province === params.name)
            let projectList = provinceProjects.slice(0, 3).map(p => `• ${p.name} (${p.expert})`).join('<br/>')
            if (provinceProjects.length > 3) {
              projectList += `<br/>还有 ${provinceProjects.length - 3} 个项目...`
            }
            
            return `
              <div style="padding: 8px;">
                <div style="font-weight: bold; color: #333; margin-bottom: 8px;">
                  ${params.name}
                </div>
                <div style="color: #666; margin-bottom: 6px;">
                  项目数量: <span style="color: #1890ff; font-weight: bold;">${projectCount}</span>
                </div>
                <div style="font-size: 12px; color: #999; margin-bottom: 4px;">项目详情:</div>
                <div style="font-size: 12px; color: #666;">
                  ${projectList}
                </div>
              </div>
            `
          } else {
            return `
              <div style="padding: 8px;">
                <div style="font-weight: bold; color: #333;">${params.name}</div>
                <div style="color: #999; font-size: 12px;">暂无项目数据</div>
              </div>
            `
          }
        },
        backgroundColor: 'rgba(255, 255, 255, 0.95)',
        borderColor: '#ccc',
        borderWidth: 1,
        textStyle: {
          color: '#333'
        }
      },
      visualMap: {
        min: 0,
        max: Math.max(...Object.values(mapStats.regionDistribution), 5),
        left: 'left',
        top: 'bottom',
        text: ['项目多', '项目少'],
        textStyle: {
          color: '#fff'
        },
        inRange: {
          color: ['#e0f3ff', '#91d5ff', '#40a9ff', '#1890ff', '#0050b3']
        },
        show: mapStats.totalProjects > 0
      },
      series: [
        {
          name: '中国',
          type: 'map',
          map: 'china',
          data: chinaData,
          roam: true,
          zoom: 1.1,
          emphasis: {
            itemStyle: {
              areaColor: '#4dabf7',
              borderColor: '#fff',
              borderWidth: 2
            },
            label: {
              show: true,
              color: '#fff',
              fontWeight: 'bold'
            }
          },
          itemStyle: {
            borderColor: 'rgba(255, 255, 255, 0.3)',
            borderWidth: 1
          },
          label: {
            show: false
          }
        }
      ]
    }

    mapChart.setOption(option)

    // 绑定点击事件
    mapChart.off('click')
    mapChart.on('click', (params) => {
      console.log('点击了:', params.name)
      if (params.name && provinces[params.name]) {
        loadProvinceMap(params.name)
      }
    })

    // 窗口大小变化监听
    const resizeHandler = () => {
      mapChart?.resize()
    }

    window.addEventListener('resize', resizeHandler)
    
    console.log('🗺️ 中国地图初始化完成')
    console.log('📊 地图数据统计:', {
      总项目数: mapStats.totalProjects,
      覆盖省份: mapStats.provinceCount,
      分布情况: mapStats.regionDistribution
    })

  } catch (error) {
    console.error('初始化中国地图失败:', error)
  }
}

// 根据项目数量生成热力图颜色
const getHeatColor = (count: number) => {
  const maxCount = Math.max(...Object.values(mapStats.regionDistribution), 1)
  const ratio = count / maxCount
  
  if (ratio > 0.8) return '#0050b3'
  if (ratio > 0.6) return '#1890ff'
  if (ratio > 0.4) return '#40a9ff'
  if (ratio > 0.2) return '#91d5ff'
  return '#e0f3ff'
}

// 加载省份地图
const loadProvinceMap = async (provinceName: string) => {
  try {
    const provinceCode = provinces[provinceName]
    const response = await fetch(`/map/province/${provinceCode}.json`)
    const mapData = await response.json()
    
    // 注册省份地图
    echarts.registerMap(provinceName, mapData)
    
    // 提取城市数据
    const provinceData = mapData.features.map((feature: any) => ({
      name: feature.properties.name
    }))

    // 更新导航历史 - 只在从全国进入时添加
    if (currentMapLevel.value === 'china') {
      mapHistory.value.push('中国')
    }
    currentMapLevel.value = 'province'
    currentMapName.value = provinceName

    // 计算省份中心点 - 从features中计算实际边界
    let minLon = Infinity, maxLon = -Infinity
    let minLat = Infinity, maxLat = -Infinity
    
    mapData.features.forEach((feature: any) => {
      if (feature.properties && feature.properties.cp) {
        // 如果有cp（center point）属性，直接使用
        const [lon, lat] = feature.properties.cp
        minLon = Math.min(minLon, lon)
        maxLon = Math.max(maxLon, lon)
        minLat = Math.min(minLat, lat)
        maxLat = Math.max(maxLat, lat)
      }
    })

    // 如果没有找到有效的边界，使用默认值
    if (minLon === Infinity) {
      minLon = 70; maxLon = 135; minLat = 15; maxLat = 55
    }

    const centerLon = (minLon + maxLon) / 2
    const centerLat = (minLat + maxLat) / 2

    // 根据省份大小调整缩放级别
    const lonRange = maxLon - minLon
    const latRange = maxLat - minLat
    const maxRange = Math.max(lonRange, latRange)
    let zoom = 1.5
    if (maxRange < 2) zoom = 3
    else if (maxRange < 4) zoom = 2.5
    else if (maxRange < 6) zoom = 2

    // 渲染省份地图 - 自动居中
    await renderMap(provinceName, provinceName, provinceData, zoom, [centerLon, centerLat])

    // 重新绑定点击事件
    mapChart?.off('click') // 移除之前的事件
    mapChart?.on('click', (params) => {
      console.log('点击了市/县:', params.name)
      console.log('当前省份:', provinceName)
      console.log('是否为直辖市:', specialRegions.includes(provinceName))
      console.log('城市映射表keys:', Object.keys(cityMap).slice(0, 10)) // 显示前10个城市
      console.log('城市映射表中是否包含该城市:', params.name in cityMap)
      
      // 如果是直辖市或特别行政区，点击返回全国
      if (specialRegions.includes(provinceName)) {
        console.log('直辖市，返回全国地图')
        initChinaMap()
        } else {
        // 尝试加载城市级地图
        if (params.name && params.name in cityMap) {
          console.log('找到城市映射，加载城市地图')
          loadCityMap(params.name, provinceName)
      } else {
          console.log(`${provinceName} - ${params.name} 暂无详细地图数据`)
          console.log('尝试查找相似名称:')
          Object.keys(cityMap).forEach(city => {
            if (city.includes(params.name.replace('市', '')) || params.name.includes(city.replace('市', ''))) {
              console.log('相似名称:', city)
            }
          })
        }
      }
    })

  } catch (error) {
    console.error('加载省份地图失败:', error)
  }
}

// 加载城市映射关系
const loadCityMapping = async () => {
  console.log('🏙️ 开始加载城市映射...')
  
  // 先设置备用城市映射，确保基本功能
  const backupCityMap = {
    // 西藏地区
    "拉萨市": "540100",
    "昌都市": "540300", 
    "山南市": "540500",
    "日喀则市": "540200",
    "那曲市": "540600",
    "阿里地区": "542500",
    "林芝市": "540400",
    // 江苏地区
    "南京市": "320100",
    "无锡市": "320200",
    "徐州市": "320300",
    "常州市": "320400",
    "苏州市": "320500",
    "南通市": "320600",
    "连云港市": "320700",
    "淮安市": "320800",
    "盐城市": "320900",
    "扬州市": "321000",
    "镇江市": "321100",
    "泰州市": "321200",
    "宿迁市": "321300"
  }
  
  cityMap = { ...backupCityMap }
  console.log('✅ 备用城市映射加载完成，共', Object.keys(cityMap).length, '个城市')
  
  // 尝试从文件加载完整映射
  try {
    console.log('🌐 尝试从文件加载完整城市映射...')
    const response = await fetch('/map/city/china-main-city-map.js')
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }
    
    const text = await response.text()
    console.log('📄 文件加载成功，大小:', text.length, '字符')
    
    // 多种解析方法
    let fullCityMap: Record<string, string> | null = null
    
    // 方法1: 直接eval执行JS代码
    try {
      // 创建一个安全的执行环境
      const executionContext = { cityMap: {} }
      const wrappedCode = `
        ${text}
        return cityMap;
      `
      fullCityMap = new Function(wrappedCode)()
      console.log('🎯 方法1成功: 直接执行JS，获得', Object.keys(fullCityMap || {}).length, '个城市')
          } catch (error) {
      console.log('❌ 方法1失败:', (error as Error).message)
    }
    
    // 方法2: 正则提取并eval
    if (!fullCityMap || Object.keys(fullCityMap).length === 0) {
      try {
        const cityMapMatch = text.match(/var cityMap = ({[\s\S]*?});/)
        if (cityMapMatch) {
          fullCityMap = eval(`(${cityMapMatch[1]})`)
          console.log('🎯 方法2成功: 正则提取，获得', Object.keys(fullCityMap || {}).length, '个城市')
        }
      } catch (error) {
        console.log('❌ 方法2失败:', (error as Error).message)
      }
    }
    
    // 方法3: 字符串替换后JSON.parse
    if (!fullCityMap || Object.keys(fullCityMap).length === 0) {
      try {
        const cityMapMatch = text.match(/var cityMap = ({[\s\S]*?});/)
        if (cityMapMatch) {
          let jsonStr = cityMapMatch[1]
          // 清理和转换为有效JSON
          jsonStr = jsonStr
            .replace(/'/g, '"')  // 单引号转双引号
            .replace(/([{,]\s*)([^":\s]+)\s*:/g, '$1"$2":')  // 无引号key加引号
            .replace(/,\s*}/g, '}')  // 移除尾随逗号
            .replace(/,\s*]/g, ']')  // 移除尾随逗号
          
          fullCityMap = JSON.parse(jsonStr)
          console.log('🎯 方法3成功: JSON解析，获得', Object.keys(fullCityMap || {}).length, '个城市')
        }
  } catch (error) {
        console.log('❌ 方法3失败:', (error as Error).message)
      }
    }
    
    // 使用成功加载的完整映射
    if (fullCityMap && Object.keys(fullCityMap).length > Object.keys(cityMap).length) {
      cityMap = fullCityMap
      console.log('🎉 完整城市映射加载成功！共', Object.keys(cityMap).length, '个城市')
      console.log('📋 包含的省份城市示例:')
      console.log('  - 西藏:', Object.keys(cityMap).filter(city => city.includes('拉萨') || city.includes('昌都')))
      console.log('  - 江苏:', Object.keys(cityMap).filter(city => city.includes('南京') || city.includes('苏州')))
      console.log('  - 广东:', Object.keys(cityMap).filter(city => city.includes('广州') || city.includes('深圳')))
              } else {
      console.log('⚠️ 无法加载完整映射，使用备用映射')
    }
    
  } catch (error: any) {
    console.log('❌ 从文件加载失败，使用备用映射:', error.message)
  }
  
  console.log('🏁 城市映射最终加载完成，共', Object.keys(cityMap).length, '个城市')
}

// 加载城市地图
const loadCityMap = async (cityName: string, provinceName: string) => {
  try {
    console.log('尝试加载城市地图:', cityName, '所属省份:', provinceName)
    
    // 检查城市映射是否存在
    if (!cityMap[cityName]) {
      console.log(`城市 ${cityName} 在映射表中不存在`)
      return
    }
    
    const cityCode = cityMap[cityName]
    console.log('城市编码:', cityCode)
    
    const response = await fetch(`/map/city/${cityCode}.json`)
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: 无法加载城市地图数据`)
    }
    
    const mapData = await response.json()
    console.log('城市地图数据加载成功:', mapData)
    
    // 注册城市地图
    echarts.registerMap(cityName, mapData)
    
    // 提取区县数据
    const cityData = mapData.features.map((feature: any) => ({
      name: feature.properties.name
    }))
    console.log('区县数据:', cityData)

    // 更新导航历史
    mapHistory.value.push(provinceName)
    currentMapLevel.value = 'city'
    currentMapName.value = cityName

    // 计算城市中心点 - 从features中计算实际边界
    let minLon = Infinity, maxLon = -Infinity
    let minLat = Infinity, maxLat = -Infinity
    
    mapData.features.forEach((feature: any) => {
      if (feature.properties && feature.properties.cp) {
        // 如果有cp（center point）属性，直接使用
        const [lon, lat] = feature.properties.cp
        minLon = Math.min(minLon, lon)
        maxLon = Math.max(maxLon, lon)
        minLat = Math.min(minLat, lat)
        maxLat = Math.max(maxLat, lat)
      } else if (feature.geometry && feature.geometry.coordinates) {
        // 如果没有cp属性，从coordinates中计算
        const coords = feature.geometry.coordinates
        const flatCoords = coords.flat(4).filter((item: any, index: number) => index % 2 === 0 || index % 2 === 1)
        
        for (let i = 0; i < flatCoords.length; i += 2) {
          if (typeof flatCoords[i] === 'number' && typeof flatCoords[i + 1] === 'number') {
            minLon = Math.min(minLon, flatCoords[i])
            maxLon = Math.max(maxLon, flatCoords[i])
            minLat = Math.min(minLat, flatCoords[i + 1])
            maxLat = Math.max(maxLat, flatCoords[i + 1])
          }
        }
      }
    })

    // 如果没有找到有效的边界，使用默认值
    if (minLon === Infinity) {
      console.log('未找到有效的地图边界，使用默认居中')
      minLon = 90; maxLon = 100; minLat = 25; maxLat = 35
    }

    const centerLon = (minLon + maxLon) / 2
    const centerLat = (minLat + maxLat) / 2
    console.log('城市中心点:', [centerLon, centerLat])

    // 城市级别使用更高的缩放
    const lonRange = maxLon - minLon
    const latRange = maxLat - minLat
    const maxRange = Math.max(lonRange, latRange)
    let zoom = 3
    if (maxRange < 0.5) zoom = 6
    else if (maxRange < 1) zoom = 5
    else if (maxRange < 2) zoom = 4
    else if (maxRange < 3) zoom = 3.5

    console.log('使用缩放级别:', zoom)

    // 渲染城市地图 - 自动居中
    await renderMap(cityName, cityName, cityData, zoom, [centerLon, centerLat])

    // 重新绑定点击事件
    mapChart?.off('click')
    mapChart?.on('click', (params) => {
      console.log('点击了区/县:', params.name)
      // 在第三级，点击可以显示详情或返回省份级别
      // 这里可以添加区县详情展示逻辑
    })

  } catch (error) {
    console.error('加载城市地图失败:', error)
    // 显示错误提示给用户
    alert(`无法加载 ${cityName} 的详细地图数据：${error}`)
  }
}

// 加载IP地址数据
const loadIPLocationData = async () => {
  try {
    console.log('🗂️ 加载IP地址数据...')
    const response = await ipApi.getAllIPs()
    
    if (response.data && Array.isArray(response.data)) {
      // 过滤有地址信息的IP
      const ipsWithLocation = response.data
        .filter((ip: any) => ip.province && ip.city)
        .map((ip: any) => ({
          name: ip.project_name,
          expert: ip.expert,
          group: ip.group_name,
          province: ip.province,
          city: ip.city,
          district: ip.district || '',
          fullAddress: ip.full_address || `${ip.province} ${ip.city}`,
          value: 1 // 每个项目计为1个点
        }))
      
      ipLocationData.value = ipsWithLocation
      
      // 统计数据
      mapStats.totalProjects = ipsWithLocation.length
      mapStats.provinceCount = new Set(ipsWithLocation.map(item => item.province)).size
      mapStats.cityCount = new Set(ipsWithLocation.map(item => item.city)).size
      
      // 省份分布统计
      mapStats.regionDistribution = {}
      ipsWithLocation.forEach(item => {
        mapStats.regionDistribution[item.province] = (mapStats.regionDistribution[item.province] || 0) + 1
      })
      
      console.log('✅ IP地址数据加载完成')
      console.log('📊 统计信息:', mapStats)
      console.log('📍 项目分布:', ipLocationData.value.slice(0, 5), '...')
      
      return ipsWithLocation
    } else {
      console.log('⚠️ 暂无IP地址数据')
      return []
    }
  } catch (error) {
    console.error('❌ 加载IP地址数据失败:', error)
    return []
  }
}

// 初始化项目类型分布图
const initTypeChart = () => {
  const chartElement = document.getElementById('typeChart')
  if (!chartElement) return

  typeChart = echarts.init(chartElement)

  const option = {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item',
      backgroundColor: 'rgba(0, 20, 40, 0.9)',
      borderColor: '#00d4ff',
      textStyle: { color: '#fff' }
    },
    legend: {
      orient: 'vertical',
      left: 'left',
      top: 'center',
      textStyle: { color: '#fff', fontSize: 10 }
    },
    series: [
      {
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['60%', '50%'],
        data: [
          { value: 35, name: '传统武术' },
          { value: 28, name: '民族舞蹈' },
          { value: 22, name: '竞技运动' },
          { value: 15, name: '其他项目' }
        ],
        itemStyle: {
          borderRadius: 5,
          borderColor: '#001830',
          borderWidth: 2
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 212, 255, 0.5)'
          }
        }
      }
    ]
  }

  typeChart.setOption(option)
}

// 初始化趋势图
const initTrendChart = () => {
  const chartElement = document.getElementById('trendChart')
  if (!chartElement) return

  trendChart = echarts.init(chartElement)

  const option = {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'rgba(0, 20, 40, 0.9)',
      borderColor: '#00d4ff',
      textStyle: { color: '#fff' }
    },
    grid: {
      left: '10%',
      right: '10%',
      top: '20%',
      bottom: '20%'
    },
    xAxis: {
      type: 'category',
      data: ['1月', '2月', '3月', '4月', '5月', '6月'],
      axisLine: { lineStyle: { color: '#00d4ff' } },
      axisLabel: { color: '#fff', fontSize: 10 }
    },
    yAxis: {
      type: 'value',
      axisLine: { lineStyle: { color: '#00d4ff' } },
      axisLabel: { color: '#fff', fontSize: 10 },
      splitLine: { lineStyle: { color: 'rgba(0, 212, 255, 0.1)' } }
    },
    series: [
      {
        data: [12, 19, 23, 25, 28, 32],
        type: 'line',
        smooth: true,
        itemStyle: { color: '#00ff88' },
        lineStyle: { color: '#00ff88', width: 2 },
        areaStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 0, y2: 1,
            colorStops: [
              { offset: 0, color: 'rgba(0, 255, 136, 0.3)' },
              { offset: 1, color: 'rgba(0, 255, 136, 0.1)' }
            ]
          }
        }
      }
    ]
  }

  trendChart.setOption(option)
}

// 创建粒子效果
const createParticles = () => {
  const container = document.querySelector('.particle-background') as HTMLElement
  if (!container) return

  // 清空现有粒子
  container.innerHTML = ''

  const particleCount = 50
  
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div')
    particle.className = 'particle'
    
    // 随机位置
    particle.style.left = Math.random() * 100 + '%'
    particle.style.top = Math.random() * 100 + '%'
    
    // 随机动画延迟
    particle.style.animationDelay = Math.random() * 10 + 's'
    
    container.appendChild(particle)
  }
}

// 窗口大小改变时重新调整图表
const handleResize = () => {
  mapChart?.resize()
  typeChart?.resize()
  trendChart?.resize()
}

// 定时器
let timeInterval: number

onMounted(async () => {
  console.log('=== Dashboard组件开始初始化 ===')
  
  // 初始化时间
  updateTime()
  timeInterval = setInterval(updateTime, 1000)
  
  // 立即加载城市映射
  console.log('开始加载城市映射...')
  await loadCityMapping()
  console.log('城市映射加载完成，当前城市数量:', Object.keys(cityMap).length)
  
  // 加载IP地址数据并初始化图表
  setTimeout(async () => {
    console.log('开始初始化图表...')
    await initChinaMap() // 这个函数内部会加载IP数据
    initTypeChart()
    initTrendChart()
    createParticles()
    console.log('图表初始化完成')
  }, 100)
  
  // 监听窗口大小变化
  window.addEventListener('resize', handleResize)
  
  console.log('=== Dashboard组件初始化完成 ===')
})

onUnmounted(() => {
  // 清理定时器
  if (timeInterval) {
    clearInterval(timeInterval)
  }
  
  // 销毁图表实例
  mapChart?.dispose()
  typeChart?.dispose()
  trendChart?.dispose()
  
  // 移除事件监听
  window.removeEventListener('resize', handleResize)
})

// 获取地图提示信息
const getMapTip = () => {
  if (currentMapLevel.value === 'china') {
    return '点击省份查看详细地图'
  } else if (currentMapLevel.value === 'province') {
    return '点击城市查看详细地图，或点击返回按钮'
  } else if (currentMapLevel.value === 'city') {
    return '点击区县查看详情，或点击返回按钮'
  }
  return '点击区域查看详情'
}

</script>

<style scoped>
.dashboard-screen {
  min-height: 100vh;
  background: linear-gradient(135deg, #001428 0%, #002b5c 50%, #001428 100%);
  color: #fff;
  position: relative;
  overflow: hidden;
  padding: 20px;
  box-sizing: border-box;
}

/* 粒子背景效果 */
.particle-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
}

.particle-background .particle {
  position: absolute;
  width: 2px;
  height: 2px;
  background: rgba(0, 212, 255, 0.6);
  border-radius: 50%;
  animation: float 8s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { 
    transform: translateY(0px) rotate(0deg);
    opacity: 0.3;
  }
  50% { 
    transform: translateY(-20px) rotate(180deg);
    opacity: 1;
  }
}

/* 顶部导航 */
.header-section {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  margin-bottom: 30px;
  z-index: 10;
  position: relative;
}

.header-left .main-title {
  font-size: 28px;
  font-weight: bold;
  margin: 0 0 10px 0;
  background: linear-gradient(45deg, #00d4ff, #00ff88);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
}

.time-display {
  font-size: 16px;
  color: #00d4ff;
  font-family: 'Courier New', monospace;
}

/* 主体内容 */
.main-content {
  display: grid;
  grid-template-columns: 300px 1fr 300px;
  gap: 30px;
  min-height: calc(100vh - 160px);
  z-index: 10;
  position: relative;
}

/* 左侧面板 */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.stat-card {
  background: rgba(0, 32, 64, 0.8);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
}

.stat-icon {
  font-size: 24px;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 212, 255, 0.2);
  border-radius: 50%;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #00ff88;
}

.stat-label {
  font-size: 14px;
  color: #ccc;
}

.ranking-card {
  background: rgba(0, 32, 64, 0.8);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
  flex: 1;
}

.ranking-card h3 {
  margin: 0 0 15px 0;
  color: #00d4ff;
  font-size: 16px;
}

.ranking-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.ranking-item {
  display: flex;
  align-items: center;
    gap: 10px;
  padding: 8px;
  border-radius: 6px;
  background: rgba(0, 212, 255, 0.1);
}

.rank-number {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 12px;
}

.rank-1 { background: #ffd700; color: #000; }
.rank-2 { background: #c0c0c0; color: #000; }
.rank-3 { background: #cd7f32; color: #fff; }
.rank-number:not(.rank-1):not(.rank-2):not(.rank-3) {
  background: #00d4ff;
  color: #fff;
}

.region-name {
  flex: 1;
  font-size: 14px;
}

.region-score {
  font-size: 14px;
  font-weight: bold;
  color: #00ff88;
}

/* 中央地图区域 */
.map-container {
  display: flex;
    flex-direction: column;
  background: rgba(0, 32, 64, 0.6);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
  position: relative;
}

.map-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.map-title {
  font-size: 20px;
  font-weight: bold;
  color: #00d4ff;
}

.map-navigation {
  display: flex;
  align-items: center;
}

.map-breadcrumb {
  display: flex;
  align-items: center;
}

.breadcrumb-item {
  cursor: pointer;
  color: #00ff88;
  margin-right: 5px;
}

.breadcrumb-separator {
  margin: 0 5px;
}

.breadcrumb-item.current {
  font-weight: bold;
}

.back-btn {
  background: none;
  border: none;
  color: #00ff88;
  font-size: 14px;
  cursor: pointer;
}

.china-map {
  flex: 1;
  min-height: 500px;
  border-radius: 8px;
}

.map-tip {
  text-align: center;
  font-size: 14px;
  color: #ccc;
  margin-top: 20px;
}

/* 右侧面板 */
.right-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.realtime-card, .chart-card {
  background: rgba(0, 32, 64, 0.8);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
}

.realtime-card h3, .chart-card h3 {
  margin: 0 0 15px 0;
  color: #00d4ff;
  font-size: 16px;
}

.data-stream {
  max-height: 200px;
  overflow-y: auto;
}

.stream-item {
  padding: 8px 0;
  border-bottom: 1px solid rgba(0, 212, 255, 0.1);
}

.stream-time {
  font-size: 12px;
  color: #00ff88;
  font-family: 'Courier New', monospace;
}

.stream-content {
    font-size: 13px;
  color: #ccc;
  margin-top: 2px;
}

.mini-chart {
  height: 150px;
}

/* 底部状态栏 */
.footer-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding: 15px 0;
  border-top: 1px solid rgba(0, 212, 255, 0.2);
  font-size: 14px;
  z-index: 10;
  position: relative;
}

.footer-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.status-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #00ff88;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.footer-right {
  color: #ccc;
}

/* 响应式设计 */
@media (max-width: 1400px) {
  .main-content {
    grid-template-columns: 250px 1fr 250px;
    gap: 20px;
  }
  
  .header-left .main-title {
    font-size: 24px;
  }
}

@media (max-width: 1200px) {
  .main-content {
    grid-template-columns: 200px 1fr 200px;
  }
  
  .stat-card {
    padding: 15px;
  }
  
  .mini-chart {
    height: 120px;
  }
}

@media (max-width: 1000px) {
  .header-section {
    flex-direction: column;
    gap: 15px;
  align-items: center;
    text-align: center;
  }
  
  .main-content {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto;
  }
  
  .left-panel, .right-panel {
    flex-direction: row;
    overflow-x: auto;
  }
  
  .stat-card, .chart-card {
    min-width: 200px;
  }
}

@media (max-width: 768px) {
  .dashboard-screen {
    padding: 15px;
  }
  
  .header-left .main-title {
    font-size: 20px;
  }
}
</style> 


